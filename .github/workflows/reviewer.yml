name: Reviewer Agent

on:
  workflow_call:
    inputs:
      issue_number:
        description: "Issue number being reviewed"
        type: string
        required: true
      pr_number:
        description: "PR number to review"
        type: string
        required: true
      review_cycle:
        description: "Current review cycle"
        type: string
        required: true
        default: "0"
      max_review_cycles:
        description: "Max review cycles before escalation"
        type: string
        required: false
        default: "3"
      project_node_id:
        description: "Project node ID for status updates"
        type: string
        required: false
        default: ""
      item_node_id:
        description: "Project item node ID for status updates"
        type: string
        required: false
        default: ""
    secrets:
      CLAUDE_CODE_OAUTH_TOKEN:
        description: "OAuth token for Claude Code CLI"
        required: false
      WORKFLOW_PAT:
        description: "PAT for cross-repo dispatch and project updates"
        required: false

jobs:
  review:
    runs-on: agentic-reviewer
    timeout-minutes: 30
    concurrency:
      group: review-issue-${{ inputs.issue_number }}
      cancel-in-progress: false
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Post run link to issue
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_PAT || secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment "${{ inputs.issue_number }}" \
            --body "**Reviewer Agent** started (cycle ${{ inputs.review_cycle }}).
          [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"

      - name: Switch to PR head ref
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_PAT || secrets.GITHUB_TOKEN }}
        run: |
          PR_BRANCH=$(gh pr view "${{ inputs.pr_number }}" --json headRefName --jq '.headRefName')
          git checkout "$PR_BRANCH"

      - name: Gather review context
        id: context
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_PAT || secrets.GITHUB_TOKEN }}
        run: |
          # Get issue details
          ISSUE_JSON=$(gh issue view "${{ inputs.issue_number }}" --json title,body)
          ISSUE_TITLE=$(echo "$ISSUE_JSON" | jq -r '.title')
          ISSUE_BODY=$(echo "$ISSUE_JSON" | jq -r '.body')

          # Get PR diff
          PR_DIFF=$(gh pr diff "${{ inputs.pr_number }}")

          # Save to files
          echo "$ISSUE_BODY" > /tmp/issue_body.md
          echo "$PR_DIFF" > /tmp/pr_diff.txt
          echo "issue_title=$ISSUE_TITLE" >> "$GITHUB_OUTPUT"

      - name: Assemble review prompt
        run: |
          PROMPT=""

          # Add agent identity
          if [ -f ".claude/agents/reviewer/IDENTITY.md" ]; then
            PROMPT+="$(cat .claude/agents/reviewer/IDENTITY.md)"
            PROMPT+=$'\n\n'
          fi

          # Add tools config
          if [ -f ".claude/agents/reviewer/TOOLS.md" ]; then
            PROMPT+="$(cat .claude/agents/reviewer/TOOLS.md)"
            PROMPT+=$'\n\n'
          fi

          # Add memory
          if [ -f ".claude/agents/reviewer/MEMORY.md" ]; then
            PROMPT+="$(cat .claude/agents/reviewer/MEMORY.md)"
            PROMPT+=$'\n\n'
          fi

          # Add last 3 log files
          LOG_DIR=".claude/agents/reviewer/logs"
          if [ -d "$LOG_DIR" ]; then
            for logfile in $(ls -1 "$LOG_DIR"/*.md 2>/dev/null | sort -r | head -3 | sort); do
              PROMPT+="## Log: $(basename "$logfile")"
              PROMPT+=$'\n'
              PROMPT+="$(cat "$logfile")"
              PROMPT+=$'\n\n'
            done
          fi

          # Add review context
          PROMPT+="---"
          PROMPT+=$'\n\n'
          PROMPT+="## Your Task"
          PROMPT+=$'\n\n'
          PROMPT+="Review PR #${{ inputs.pr_number }} for Issue #${{ inputs.issue_number }}: ${{ steps.context.outputs.issue_title }}"
          PROMPT+=$'\n\n'
          PROMPT+="### Issue Description:"
          PROMPT+=$'\n\n'
          PROMPT+="$(cat /tmp/issue_body.md)"
          PROMPT+=$'\n\n'
          PROMPT+="### PR Diff:"
          PROMPT+=$'\n\n'
          PROMPT+='```diff'
          PROMPT+=$'\n'
          PROMPT+="$(cat /tmp/pr_diff.txt)"
          PROMPT+=$'\n'
          PROMPT+='```'
          PROMPT+=$'\n\n'

          # Add instructions
          PROMPT+="---"
          PROMPT+=$'\n\n'
          PROMPT+="## Instructions"
          PROMPT+=$'\n\n'
          PROMPT+="1. Read and understand the issue requirements"
          PROMPT+=$'\n'
          PROMPT+="2. Review the code changes in the PR diff above"
          PROMPT+=$'\n'
          PROMPT+="3. Check: Does the code fulfill the issue requirements?"
          PROMPT+=$'\n'
          PROMPT+="4. Check: Are there tests for new functionality?"
          PROMPT+=$'\n'
          PROMPT+="5. Check: Is the code clean, secure, and maintainable?"
          PROMPT+=$'\n'
          PROMPT+="6. Post your review using gh pr review:"
          PROMPT+=$'\n'
          PROMPT+="   - If approved: gh pr review ${{ inputs.pr_number }} --approve --body \"Your approval message\""
          PROMPT+=$'\n'
          PROMPT+="   - If changes needed: gh pr review ${{ inputs.pr_number }} --request-changes --body \"Your detailed feedback\""
          PROMPT+=$'\n'
          PROMPT+="7. Write a log entry for today to .claude/agents/reviewer/logs/$(date +%Y-%m-%d).md"
          PROMPT+=$'\n\n'
          PROMPT+="IMPORTANT: You MUST post exactly one review using gh pr review. Either --approve or --request-changes."

          echo "$PROMPT" > /tmp/reviewer_prompt.md

      - name: Run Claude Code
        id: claude
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          GH_TOKEN: ${{ secrets.WORKFLOW_PAT || secrets.GITHUB_TOKEN }}
          CLAUDECODE: ""
        run: |
          SESSION_ID=$(python3 -c "import uuid; print(uuid.uuid5(uuid.NAMESPACE_URL, '${{ github.repository }}/issues/${{ inputs.issue_number }}/review'))")

          # Try to resume existing session; fall back to new session if not found
          claude -p "$(cat /tmp/reviewer_prompt.md)" \
            --resume "$SESSION_ID" \
            --dangerously-skip-permissions \
            --output-format json \
            --max-turns 30 \
            --model sonnet \
            > /tmp/claude_output.json 2>/tmp/claude_stderr.log || {
              EXIT_CODE=$?
              if grep -qi "no conversation found" /tmp/claude_stderr.log 2>/dev/null; then
                echo "::notice::No existing session, starting fresh"
                claude -p "$(cat /tmp/reviewer_prompt.md)" \
                  --dangerously-skip-permissions \
                  --output-format json \
                  --max-turns 30 \
                  --model sonnet \
                  > /tmp/claude_output.json 2>/tmp/claude_stderr.log || {
                    EXIT_CODE=$?
                    echo "claude_failed=true" >> "$GITHUB_OUTPUT"
                    echo "::error::Claude Code (reviewer) exited with code $EXIT_CODE"
                    cat /tmp/claude_stderr.log
                    exit 0
                  }
              else
                echo "claude_failed=true" >> "$GITHUB_OUTPUT"
                echo "::error::Claude Code (reviewer) exited with code $EXIT_CODE"
                cat /tmp/claude_stderr.log
                exit 0
              fi
            }
          echo "claude_failed=false" >> "$GITHUB_OUTPUT"

      - name: Handle Claude failure
        if: steps.claude.outputs.claude_failed == 'true'
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_PAT || secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment "${{ inputs.issue_number }}" \
            --body "Reviewer agent failed on cycle ${{ inputs.review_cycle }}. [See workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          exit 1

      - name: Check review decision
        if: steps.claude.outputs.claude_failed != 'true'
        id: decision
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_PAT || secrets.GITHUB_TOKEN }}
        run: |
          # Check the latest review on the PR
          REVIEW_STATE=$(gh pr view "${{ inputs.pr_number }}" \
            --json reviews --jq '.reviews | sort_by(.submittedAt) | last | .state')

          echo "review_state=$REVIEW_STATE" >> "$GITHUB_OUTPUT"
          echo "::notice::Review decision: $REVIEW_STATE"

      - name: Handle approval
        if: steps.decision.outputs.review_state == 'APPROVED'
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_PAT || secrets.GITHUB_TOKEN }}
        run: |
          echo "::notice::PR #${{ inputs.pr_number }} approved! Status stays on 'In review' for human review."

          # Status stays on "In review" — no project board update needed.
          # The user will move to "Done" after merging the PR.

          gh issue comment "${{ inputs.issue_number }}" \
            --repo "${{ github.repository }}" \
            --body "**Reviewer Agent** (cycle ${{ inputs.review_cycle }}): PR #${{ inputs.pr_number }} approved. Please review and merge the PR, then move the issue to Done."

      - name: Handle changes requested
        if: steps.decision.outputs.review_state == 'CHANGES_REQUESTED'
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_PAT }}
        run: |
          NEXT_CYCLE=$(( ${{ inputs.review_cycle }} + 1 ))

          if [ "$NEXT_CYCLE" -ge "${{ inputs.max_review_cycles }}" ]; then
            echo "::warning::Max review cycles (${{ inputs.max_review_cycles }}) reached. Escalating to human."

            gh label create "needs-human-review" --color "FBCA04" \
              --description "Agent review cycles exhausted" 2>/dev/null || true
            gh issue edit "${{ inputs.issue_number }}" --add-label "needs-human-review"
            gh issue comment "${{ inputs.issue_number }}" \
              --body "**Reviewer Agent**: Max review cycles (${{ inputs.max_review_cycles }}) reached. Please review PR #${{ inputs.pr_number }} manually."
          else
            echo "::notice::Changes requested. Starting cycle $NEXT_CYCLE."

            # Update review-cycle label
            gh label create "review-cycle:${NEXT_CYCLE}" --color "0E8A16" \
              --description "Review cycle counter" 2>/dev/null || true
            gh issue edit "${{ inputs.issue_number }}" \
              --remove-label "review-cycle:${{ inputs.review_cycle }}" 2>/dev/null || true
            gh issue edit "${{ inputs.issue_number }}" \
              --add-label "review-cycle:${NEXT_CYCLE}"

            # Update project status back to Ready
            if [ -n "${{ inputs.project_node_id }}" ]; then
              FIELD_DATA=$(gh api graphql -f query='
                query($projectId: ID!) {
                  node(id: $projectId) {
                    ... on ProjectV2 {
                      fields(first: 20) {
                        nodes {
                          ... on ProjectV2SingleSelectField {
                            id
                            name
                            options { id name }
                          }
                        }
                      }
                    }
                  }
                }' -f projectId="${{ inputs.project_node_id }}" \
                --jq '.data.node.fields.nodes[] | select(.name == "Status")')

              FIELD_ID="$(echo "$FIELD_DATA" | jq -r '.id')"
              OPTION_ID="$(echo "$FIELD_DATA" | jq -r '.options[] | select(.name == "Ready") | .id')"

              gh api graphql -f query='
                mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                  updateProjectV2ItemFieldValue(input: {
                    projectId: $projectId
                    itemId: $itemId
                    fieldId: $fieldId
                    value: { singleSelectOptionId: $optionId }
                  }) {
                    projectV2Item { id }
                  }
                }' \
                -f projectId="${{ inputs.project_node_id }}" \
                -f itemId="${{ inputs.item_node_id }}" \
                -f fieldId="$FIELD_ID" \
                -f optionId="$OPTION_ID"
            fi

            # Status is now "Ready" — the board event will trigger the orchestrator,
            # which will dispatch the developer for the next cycle.
          fi
